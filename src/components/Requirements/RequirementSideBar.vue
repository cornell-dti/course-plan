<template v-if="semesters">
  <div>
    <button
      v-if="isMinimized && showToggleRequirementsBtn"
      class="requirement-sidebar-btn-open"
      @click="toggleMinimized"
    >
      →
    </button>
    <aside v-if="isMobile ? isDisplayingMobile : !isMinimized" class="requirements">
      <div
        class="requirements-wrapper"
        data-intro-group="req-tooltip"
        :data-intro="getRequirementsTooltipText()"
        data-disable-interaction="1"
        data-step="1"
        data-tooltipClass="tooltipCenter tourStep1"
      >
        <!-- loop through reqs array of req objects -->
        <div
          class="fixed"
          :class="{
            'd-none': shouldShowAllCourses,
          }"
          data-intro-group="req-tooltip"
          :data-intro="getCoursesTooltipText()"
          data-disable-interaction="1"
          data-step="2"
          data-tooltipClass="tooltipCenter tourStep2"
        >
          <button
            class="requirement-debugger-toggler"
            v-if="debuggerAllowed"
            @click="toggleDebugger()"
          >
            Open Requirement Debugger
          </button>
          <teleport-modal
            content-class="requirement-debugger-modal-content"
            :isSimpleModal="true"
            v-if="displayDebugger"
          >
            <button class="requirement-debugger-toggler" @click="toggleDebugger()">
              Close Requirement Debugger
            </button>
            <requirement-debugger />
          </teleport-modal>
          <div v-if="showToggleRequirementsBtn" class="requirement-sidebar-header">
            <button class="requirement-sidebar-btn-close" @click="toggleMinimized">←</button>
          </div>
          <div
            class="req"
            v-for="(req, index) in groupedRequirementFulfillmentReports"
            :key="index"
          >
            <requirement-group
              :req="req"
              :reqIndex="index"
              :toggleableRequirementChoices="toggleableRequirementChoices"
              :displayedMajorIndex="displayedMajorIndex"
              :displayedMinorIndex="displayedMinorIndex"
              :showMajorOrMinorRequirements="showMajorOrMinorRequirements(index, req.groupName)"
              :numOfColleges="numOfColleges"
              :tourStep="tourStep"
              @changeToggleableRequirementChoice="chooseToggleableRequirementOption"
              @activateMajor="activateMajor"
              @activateMinor="activateMinor"
              @onShowAllCourses="onShowAllCourses"
            />
          </div>
        </div>
      </div>
      <div class="fixed see-all-padding-y" v-if="shouldShowAllCourses">
        <div class="see-all-padding-x see-all-header pb-3">
          <span class="arrow-left">
            <drop-down-arrow :isPointingLeft="true" :fillColor="'#32A0F2'" />
          </span>
          <button class="btn back-button p-0" @click="backFromSeeAll">
            GO BACK TO REQUIREMENTS
          </button>
        </div>
        <div class="see-all-padding-x py-3">
          <h1 class="title">{{ showAllCourses.name }}</h1>

          <p>
            Courses are sorted by most popular to least popular classes used to fulfill this
            requirement.
          </p>

          <h2>Search Courses</h2>
          <input
            v-model="searchText"
            class="search-box"
            @focus="clearDefault"
            @blur="restoreDefault"
          />

          <draggable
            :modelValue="filteredCourses"
            :clone="cloneCourse"
            item-key="code"
            :group="{ name: 'draggable-semester-courses', put: false }"
          >
            <template #item="{ element }">
              <div>
                <div class="mt-3">
                  <course
                    :courseObj="element"
                    :compact="false"
                    :active="false"
                    :isReqCourse="true"
                    class="requirements-course"
                  />
                </div>
              </div>
            </template>
          </draggable>
        </div>
      </div>
    </aside>
  </div>
</template>

<script lang="ts">
import draggable from 'vuedraggable';
import { defineComponent } from 'vue';
import introJs from 'intro.js';
import featureFlagCheckers from '@/feature-flags';

import Course from '@/components/Course/Course.vue';
import TeleportModal from '@/components/Modals/TeleportModal.vue';
import RequirementDebugger from '@/components/Requirements/RequirementDebugger.vue';
import RequirementGroup from '@/components/Requirements/RequirementGroup.vue';
import DropDownArrow from '@/components/DropDownArrow.vue';

import clipboard from '@/assets/images/clipboard.svg';
import warning from '@/assets/images/warning.svg';
import store from '@/store';
import { chooseToggleableRequirementOption, incrementUniqueID } from '@/global-firestore-data';

export type ShowAllCourses = {
  readonly name: string;
  shownCourses: readonly FirestoreSemesterCourse[];
  readonly allCourses: readonly FirestoreSemesterCourse[];
};

type Data = {
  displayDebugger: boolean;
  displayedMajorIndex: number;
  displayedMinorIndex: number;
  numOfColleges: number;
  showAllCourses: ShowAllCourses;
  shouldShowAllCourses: boolean;
  tourStep: number;
  defaultText: string;
  searchText: string;
};

// This section will be revisited when we try to make first-time tooltips
const tour = introJs().start();
tour.setOptions({
  exitOnEsc: false,
  doneLabel: 'Next',
  nextLabel: 'Next',
  exitOnOverlayClick: false,
});

export default defineComponent({
  components: {
    draggable,
    Course,
    DropDownArrow,
    RequirementDebugger,
    RequirementGroup,
    TeleportModal,
  },
  props: {
    startTour: { type: Boolean, required: true },
    isDisplayingMobile: { type: Boolean, required: true },
    isMobile: { type: Boolean, required: true },
    isMinimized: { type: Boolean, required: true },
  },
  emits: ['showTourEndWindow', 'toggleMinimized'],
  data(): Data {
    return {
      displayDebugger: false,
      displayedMajorIndex: 0,
      displayedMinorIndex: 0,
      numOfColleges: 1,
      showAllCourses: { name: '', shownCourses: [], allCourses: [] },
      shouldShowAllCourses: false,
      tourStep: 0,
      defaultText: '"CS 1110", "Multivariable Calculus", etc.',
      searchText: '"CS 1110", "Multivariable Calculus", etc.',
    };
  },
  watch: {
    startTour() {
      tour.start();
      tour.oncomplete(() => {
        this.$emit('showTourEndWindow');
      });
      tour.onbeforechange(() => {
        if (tour.currentStep()) {
          this.tourStep = tour.currentStep() as number;
        }
      });
      tour.onexit(() => {
        // resets tourStep in case skipped at step = 1
        this.tourStep = 0;
      });
    },
  },
  computed: {
    /**
     * @brief Filters courses based on search text and returns the first 50 courses that match the search text
     * @return {readonly FirestoreSemesterCourse[]} filtered courses
     */
    filteredCourses() {
      if (this.searchText.trim() === '' || this.searchText === this.defaultText) {
        return this.showAllCourses.allCourses.slice(0, 50); // Show all courses if search text is empty
      }
      const search = this.searchText.toLowerCase();

      // only filter for first 50 courses
      const res = this.showAllCourses.allCourses.filter(
        course =>
          course.name.toLowerCase().includes(search) || course.code.toLowerCase().includes(search)
      );

      return res.slice(0, 50); // Only show first 50 courses
    },
    /**
     * @brief Checks if debugger is allowed to be displayed (feature flag)
     * @return {boolean} true if debugger is allowed
     */
    debuggerAllowed(): boolean {
      return featureFlagCheckers.isRequirementDebuggerEnabled();
    },
    /**
     * @brief Returns semesters from store
     * @return {readonly FirestoreSemester[]} semesters
     */
    semesters(): readonly FirestoreSemester[] {
      return store.state.semesters;
    },
    /**
     * @brief Returns onboarding data
     * @return {AppOnboardingData} onboarding data
     */
    onboardingData(): AppOnboardingData {
      return store.state.onboardingData;
    },
    /**
     * @brief Returns toggleable requirement choices
     * @return {AppToggleableRequirementChoices} toggleable requirement choices
     */
    toggleableRequirementChoices(): AppToggleableRequirementChoices {
      return store.state.toggleableRequirementChoices;
    },
    /**
     * @brief Returns grouped requirement fulfillment reports
     * @return {readonly GroupedRequirementFulfillmentReport[]} grouped requirement fulfillment reports
     */
    groupedRequirementFulfillmentReports(): readonly GroupedRequirementFulfillmentReport[] {
      return store.state.groupedRequirementFulfillmentReport;
    },
    /**
     * @brief Returns true if the toggle requirements bar button should be shown
     * @return {boolean} true if the toggle requirements bar button should be shown
     */
    showToggleRequirementsBtn(): boolean {
      return !this.isMobile && featureFlagCheckers.isToggleRequirementsBarBtnEnabled();
    },
  },
  methods: {
    filterCourses() {
      // Triggered on input change in the search box
      // This will automatically update the filteredCourses computed property
    },
    /**
     * @brief Clears the default text in the search box
     */
    clearDefault() {
      if (this.searchText === this.defaultText) {
        this.searchText = ''; // Clear the default value when input is focused
      }
    },
    /**
     * @brief Restores the default text in the search box
     */
    restoreDefault() {
      if (!this.searchText) {
        this.searchText = this.defaultText; // Restore default value if no input
      }
    },
    /**
     * @brief Toggles the debugger
     */
    toggleDebugger(): void {
      this.displayDebugger = !this.displayDebugger;
    },
    // TODO CHANGE FOR MULTIPLE COLLEGES & GRAD PROGRAMS
    /**
     * @brief Returns true if the requirement should be shown
     * @param {number} id requirement id
     * @param {string} group requirement group
     * @return {boolean} true if the requirement should be shown
     */
    showMajorOrMinorRequirements(id: number, group: string): boolean {
      // colleges and programs should always be shown as there can only be 1
      if (group === 'College' || group === 'Grad') {
        return true;
      }
      // majors should be shown only if the id matches the index of the displayed major
      if (group === 'Major') {
        return id === this.displayedMajorIndex + this.numOfColleges;
      }
      // minors should be shown depending on index and number of college and majors selected
      return (
        id === this.displayedMinorIndex + this.numOfColleges + this.onboardingData.major.length
      );
    },
    /**
     * @brief Chooses a toggleable requirement option
     */
    chooseToggleableRequirementOption(requirementID: string, option: string): void {
      chooseToggleableRequirementOption(requirementID, option);
    },
    /**
     * @brief Activates a major
     * @param {number} id major id
     */
    activateMajor(id: number) {
      this.displayedMajorIndex = id;
    },
    /**
     * @brief Activates a minor
     * @param {number} id minor id
     */
    activateMinor(id: number) {
      this.displayedMinorIndex = id;
    },
    /**
     * @brief Returns the requirements tooltip text
     * @return {string} requirements tooltip text
     */
    getRequirementsTooltipText() {
      return `<div class="introjs-tooltipTop"><div class="introjs-customTitle">Meet your Requirements Bar <img src="${clipboard}" class = "introjs-emoji introjs-emoji-text" alt="clipboard icon"/>
          </div><div class="introjs-customProgress">1/4</div></div><div class = "introjs-bodytext">Based on your school and major/minor, we’ve compiled your requirements and
          required courses.<br><img src="${warning}" class = "introjs-emoji-text" alt="warning icon"/> Some requirements
          aren’t fully tracked by us yet, so pay attention to the warnings.</div>`;
    },
    /**
     * @brief Returns tooltip text for courses
     */
    getCoursesTooltipText() {
      return `<div class="introjs-tooltipTop"><div class="introjs-customTitle">These are your Courses</div><div class="introjs-customProgress">2/4</div>
      </div><div class = "introjs-bodytext">Drag and drop courses into your schedule! Click on them to learn more information like their descriptions.</div>`;
    },
    /**
     * @brief Modify this.state.showAllCourses to show all courses based on showAllCourses object
     * @param {ShowAllCourses} showAllCourses show all courses object
     */
    onShowAllCourses(showAllCourses: {
      requirementName: string;
      subReqCoursesArray: readonly FirestoreSemesterCourse[];
    }) {
      this.shouldShowAllCourses = true;

      this.showAllCourses = {
        name: showAllCourses.requirementName,
        shownCourses: showAllCourses.subReqCoursesArray,
        allCourses: showAllCourses.subReqCoursesArray,
      };
    },
    /**
     * @brief Changes showAllCourses to false because user clicked back button and showAllCourses to empty object
     */
    backFromSeeAll() {
      this.shouldShowAllCourses = false;
      this.showAllCourses = { name: '', shownCourses: [], allCourses: [] };
    },
    /**
     * @brief Clones a course
     * @param {FirestoreSemesterCourse} courseWithDummyUniqueID course with dummy unique id
     * @return {FirestoreSemesterCourse} cloned course
     */
    cloneCourse(courseWithDummyUniqueID: FirestoreSemesterCourse): FirestoreSemesterCourse {
      return { ...courseWithDummyUniqueID, uniqueID: incrementUniqueID() };
    },
    /**
     * @brief Toggles the minimized state
     */
    toggleMinimized() {
      this.$emit('toggleMinimized');
    },
  },
});
</script>

<style scoped lang="scss">
@import '@/assets/scss/_variables.scss';
.requirement-sidebar-header {
  display: flex;
  justify-content: flex-end;
}

@mixin requirement-sidebar-btn {
  color: #7b7d7e;
  background: white;
  font-size: 2rem;
  font-family: monospace;
  z-index: 1;

  &:hover {
    color: $yuxuanBlue;
    opacity: 1;
  }
}

.requirement-sidebar-btn-open {
  @include requirement-sidebar-btn;
  position: fixed;
  top: 2rem;
  box-shadow: 2px 0px 10px 0px #dddddd;
  border-top-right-radius: 10px;
  border-bottom-right-radius: 10px;
}

.requirement-sidebar-btn-close {
  @include requirement-sidebar-btn;
  position: absolute;
  line-height: 2rem;
  top: auto;
  margin-top: 1rem;
}

.requirement-debugger-toggler {
  background: $medGray;
  color: white;
}
.separator {
  height: 1px;
  width: 100%;
  background-color: $inactiveGray;
}
.requirements-wrapper {
  width: 100%;
  height: 100%;
}
.requirements,
.fixed {
  z-index: 1;
  height: 100%;
  width: 25rem;
  background-color: $white;
}
.fixed {
  position: fixed;
  top: 0;
  overflow-y: scroll;
  overflow-x: hidden;
}
.fixed,
.see-all-padding {
  padding: 1.625rem 1.5rem;
}
.see-all-padding-y {
  padding: 1.625rem 0;
}
.see-all-padding-x {
  padding: 0 1.625rem;
}
.see-all-header {
  box-shadow: 0 4px 8px -8px gray;
}
.see-all-pages {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 21.375rem;
}
.see-all-pageCount {
  font-size: 16px;
  line-height: 19px;
  color: $primaryGray;
}
.see-all-buttonWrapper {
  display: flex;
}
.see-all-button {
  width: 4.75rem;
  height: 2rem;
  color: $sangBlue;
  border-radius: 3px;
  border: 1px solid $sangBlue;
  background-color: $white;
  display: flex;
  justify-content: center;
  margin-top: auto;
  margin-bottom: auto;

  &:first-child {
    margin-right: 1rem;
  }

  &-left {
    display: flex;
    flex-direction: row;
    justify-content: center;
  }

  &-text {
    margin-top: auto;
    margin-bottom: auto;
  }

  &--disabled {
    opacity: 0.3;
    border: 1px solid $sangBlue;
    background-color: $disabledGray;
  }
}

h1.title {
  font-style: normal;
  font-weight: 550;
  font-size: 22px;
  line-height: 29px;
  color: $black;
}
.req {
  margin-top: auto;
  margin-bottom: auto;
  font-style: normal;
  font-weight: normal;
  font-size: 16px;
  line-height: 19px;
  &-name {
    font-weight: 600;
    font-size: 14px;
    line-height: 14px;
    align-self: center;
  }
  &-progress {
    font-size: 12px;
    line-height: 12px;
  }
}

.back-button {
  color: $yuxuanBlue;
  font-size: 0.9rem;
}

.arrow-left {
  transform: rotate(90deg);
}

.requirements-course {
  width: 21.375rem;
}

@import '@/assets/scss/_variables.scss';

.search-box {
  border: 1px solid transparent;
  background-color: $searchBoxWhite;
  padding: 10px;
  font-size: 16px;
  width: 100%;
  color: $lightPlaceholderGray;
}

@media only screen and (max-width: $large-breakpoint) {
  .requirements,
  .fixed {
    width: 21rem;
  }
  .see-all-pages {
    width: 17rem;
  }

  .requirements-course {
    width: 17rem;
  }
}

@media only screen and (max-width: $medium-breakpoint) {
  .requirements {
    position: fixed;
    width: 100%;
    padding-left: 0.5rem;
    top: 4.5rem;
  }

  .fixed {
    top: 4.5rem;
    left: 0rem;
    width: 100%;
    height: calc(100vh - 4.5rem);
  }
}
</style>
<style lang="scss">
.modal-content.requirement-debugger-modal-content {
  display: flex;
  align-items: center;
  background: white;
  padding: 2em;
  width: calc(100% - 10em);
  height: 100vh;
  overflow: scroll;
}
</style>
